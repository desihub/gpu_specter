#!/bin/bash
# 
# Example usage:  
# > srun -n 2 -c 1 mps-wrapper command arg1 arg2 ...
#

# https://docs.nvidia.com/deploy/mps/index.html
export CUDA_MPS_PIPE_DIRECTORY=/tmp/nvidia-mps
export CUDA_MPS_LOG_DIRECTORY=/tmp/nvidia-log

# https://docs.nvidia.com/deploy/mps/index.html#topic_3_3_5_2
# export CUDA_MPS_ACTIVE_THREAD_PERCENTAGE=$((100 / $SLURM_NTASKS))
# export CUDA_MPS_ACTIVE_THREAD_PERCENTAGE=$((200 / $SLURM_NTASKS))

NTASKS_PER_NODE=$((SLURM_NTASKS / SLURM_NNODES))
NODE_RANK=$((SLURM_PROCID % NTASKS_PER_NODE))

if [ $NODE_RANK -eq 0 ]; then
    echo $SLURM_PROCID starting nvidia-cuda-mps-control on $(hostname)
    nvidia-cuda-mps-control -d
fi

sleep 5

if [ $NODE_RANK -eq 0 ]; then
    echo "mps ready: $(date --iso-8601=seconds)"
fi

# run the command
"$@"

if [ $NODE_RANK -eq 0 ]; then
    echo $SLURM_PROCID stopping nvidia-cuda-mps-control on $(hostname)
    echo quit | nvidia-cuda-mps-control
fi
